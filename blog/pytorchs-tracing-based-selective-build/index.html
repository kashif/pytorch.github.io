<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-T8XT4PS');</script>
  <!-- End Google Tag Manager -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">
  <title>
    
      PyTorch’s Tracing Based Selective Build | PyTorch
    
  </title>
  <meta name="robots" content="index, follow" />

<meta name="description" content="Introduction

" />

  <meta property="og:image" content="https://pytorch.org//assets/images/pytorchs-tracing-based-selective-build_Figure_4.png" />
  <meta name="twitter:image" content="https://pytorch.org//assets/images/pytorchs-tracing-based-selective-build_Figure_4.png" />

<meta property="og:locale" content="en_US" />
<meta property="og:type" content="website" />
<meta property="og:title" content="PyTorch’s Tracing Based Selective Build" />
<meta property="og:description" content="Introduction

" />
<meta property="og:site_name" content="PyTorch" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="PyTorch’s Tracing Based Selective Build" />
<meta name="twitter:description" content="Introduction

" />

  <link rel="stylesheet" href="/assets/main.css">
  <script src="/assets/vendor/jquery.min.js"></script>
  <script src="/assets/vendor/popper.min.js"></script>
  <script src="/assets/vendor/bootstrap.min.js"></script>
  <script src="/assets/vendor/anchor.min.js"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        inlineMath: [['$','$']]
      }
    });
  </script>
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
  
    <script
  async
  src="https://www.googletagmanager.com/gtag/js?id=UA-117752657-2"
></script>

<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", "UA-117752657-2");
</script>

    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '243028289693773');
    fbq('track', 'PageView');
</script>

<noscript>
  <img height="1" width="1"
  src="https://www.facebook.com/tr?id=243028289693773&ev=PageView
  &noscript=1"/>
</noscript>

    <!-- Twitter universal website tag code -->
<img height="1" width="1" style="display:none;" alt="" src="https://analytics.twitter.com/i/adsct?p_id=Twitter&p_user_id=0&txn_id=o2gi1&events=%5B%5B%22pageview%22%2Cnull%5D%5D&tw_sale_amount=0&tw_order_quantity=0 (https://urldefense.proofpoint.com/v2/url?u=https-3A__analytics.twitter.com_i_adsct-3Fp-5Fid-3DTwitter-26p-5Fuser-5Fid-3D0-26txn-5Fid-3Do2gi1-26events-3D-255B-255B-2522pageview-2522-252Cnull-255D-255D-26tw-5Fsale-5Famount-3D0-26tw-5Forder-5Fquantity-3D0&d=DwMGaQ&c=5VD0RTtNlTh3ycd41b3MUw&r=GMr8XYCDyeQQZuD3noL91A&m=dAJyokk16UvYy-vMrGn_JwYiGfp_eEgo25B9iGDCG-A&s=o6i4D0V0088WH2RnzIoqiF-vj45PL-2sTrsxQ0SNO3A&e=)" />
<img height="1" width="1" style="display:none;" alt="" src="//t.co/i/adsct?p_id=Twitter&p_user_id=0&txn_id=o2gi1&events=%5B%5B%22pageview%22%2Cnull%5D%5D&tw_sale_amount=0&tw_order_quantity=0 (https://urldefense.proofpoint.com/v2/url?u=https-3A__linkprotect.cudasvc.com_url-3Fa-3Dhttp-253a-252f-252ft.co-252fi-252fadsct-253fp-5Fid-253dTwitter-2526p-5Fuser-5Fid-253d0-2526txn-5Fid-253do2gi1-2526events-253d-25255B-25255B-252522pageview-252522-25252Cnull-25255D-25255D-2526tw-5Fsale-5Famount-253d0-2526tw-5Forder-5Fquantity-253d0-26c-3DE-2C1-2CC33dLwIhtuEcl5FhdztSnUwsioeej5k-2DWy0RYREBAq51kGji32A2Cw94YU9vQBpY5tPN3AukEw3C-5F-2DlbtndnLoR7-5FA-5FLoH0Rr7zLtP1ykptN-26typo-3D1&d=DwMGaQ&c=5VD0RTtNlTh3ycd41b3MUw&r=GMr8XYCDyeQQZuD3noL91A&m=dAJyokk16UvYy-vMrGn_JwYiGfp_eEgo25B9iGDCG-A&s=Abgc3XBkhESv8XBYtLchdDZyISGsK6v_BB6cLMJGyCw&e=)" />
<!-- End Twitter universal website tag code -->

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Pythorch Blog Posts" />
</head>


<body class="blog">
    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8XT4PS"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

    <div class="main-background blog-background blog-detail-background"></div>

    <div class="container-fluid header-holder blog-detail-header">
        <div class="container">
            

<div class="header-container">
  <a class="header-logo" href="https://pytorch.org" aria-label="PyTorch"></a>

  <div class="main-menu">
  <ul>
    <li class="main-menu-item ">
      <a href="/get-started">Get Started</a>
    </li>

    <li class="main-menu-item">
      <div id="dropdownMenuButton" data-toggle="resources-dropdown" class="resources-dropdown">
        <a class="resource-option with-down-arrow">
          Ecosystem 
        </a>
        <div class="resources-dropdown-menu">
          <a class="nav-dropdown-item" href="https://events.linuxfoundation.org/pytorch-conference/">
            <span class="dropdown-title">PyTorch Conference - 2024</span>
            <p>September 18-19 in San Francisco</p>
          </a>
          <a class="nav-dropdown-item" href="/ecosystem">
            <span class="dropdown-title">Tools</span>
            <p>Learn about the tools and frameworks in the PyTorch Ecosystem</p>
          </a>
        </div>
      </div>
    </li>

    <li class="main-menu-item">
      <div id="dropdownMenuButton" data-toggle="resources-dropdown" class="resources-dropdown">
        <a class="resource-option with-down-arrow">
          Edge 
        </a>
        <div class="resources-dropdown-menu">
          <a class="nav-dropdown-item" href="/edge">
            <span class="dropdown-title">About PyTorch Edge</span>
          </a>
          <a class="nav-dropdown-item" href="/executorch-overview">
            <span class="dropdown-title">ExecuTorch</span>
          </a>
        </div>
      </div>
    </li>

    <li class="main-menu-item active">
      <a href="/blog">Blog</a>
    </li>

    <li class="main-menu-item">
      <a href="https://pytorch.org/tutorials">Tutorials</a>
    </li>

    <li class="main-menu-item">
      <div id="docsDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
        <a class="resource-option with-down-arrow">
          Docs
        </a>
        <div class="resources-dropdown-menu">
          <a class="nav-dropdown-item" href="/docs">
            <span class="dropdown-title docs-title">PyTorch</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/audio">
            <span class="dropdown-title docs-title">torchaudio</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/text">
            <span class="dropdown-title docs-title">torchtext</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/vision">
            <span class="dropdown-title docs-title">torchvision</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/torcharrow">
            <span class="dropdown-title docs-title">torcharrow</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/data">
            <span class="dropdown-title docs-title">TorchData</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/torchrec">
            <span class="dropdown-title docs-title">TorchRec</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/serve">
            <span class="dropdown-title docs-title">TorchServe</span>
            <p></p>
          </a>
          <a class="nav-dropdown-item" href="/xla/release/1.6/index.html">
            <span class="dropdown-title docs-title">PyTorch on XLA Devices</span>
            <p></p>
          </a>
        </div>
      </div>
    </li>

    

    <li class="main-menu-item ">

      <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
        <a class="resource-option with-down-arrow">
          Resources
        </a>
        <div class="resources-dropdown-menu">
          <a class="nav-dropdown-item" href="/features">
            <span class=dropdown-title>About</span>
            <p>Learn about PyTorch’s features and capabilities</p>
          </a>
          <a class="nav-dropdown-item" href="/foundation">
            <span class=dropdown-title>PyTorch Foundation</span>
            <p>Learn more about the PyTorch Foundation.</p>
          </a>
          <a class="nav-dropdown-item" href="/#community-module">
            <span class=dropdown-title>Community</span>
            <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
          </a>
          <a class="nav-dropdown-item" href="/community-stories">
            <span class=dropdown-title>Community stories</span>
            <p>Learn how our community solves real, everyday machine learning problems with PyTorch</p>
          </a>
          <a class="nav-dropdown-item" href="/resources">
            <span class=dropdown-title>Developer Resources</span>
            <p>Find resources and get questions answered</p>
          </a>
          <a class="nav-dropdown-item" href="/events">
            <span class=dropdown-title>Events</span>
            <p>Find events, webinars, and podcasts</p>
          </a>
          <a class="nav-dropdown-item" href="https://discuss.pytorch.org" target="_blank">
            <span class=dropdown-title>Forums</span>
            <p>A place to discuss PyTorch code, issues, install, research</p>
          </a>
          <a class="nav-dropdown-item" href="/hub">
            <span class=dropdown-title>Models (Beta)</span>
            <p>Discover, publish, and reuse pre-trained models</p>
          </a>
        </div>
      </div>
    </li>

    <li class="main-menu-item" id="github-main-menu-link">
      <a href="https://github.com/pytorch/pytorch">GitHub</a>
    </li>

    <li class="navSearchWrapper reactNavSearchWrapper" key="search">
      <div class="search-border">
        <div id="search-icon"></div>
        <input
          id="search-input"
          type="text"
          title="Search"
        />
        <div id="close-search">X</div>
      </div>
    </li>
  </ul>
</div>

<script src="/assets/main-menu-dropdown.js"></script>


  <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
</div>

        </div>
    </div>

    <div class="jumbotron jumbotron-fluid blog-detail-jumbotron">
        <div class="container blog-detail-container">
            <p class="featured-post">October 17, 2022</p>
            <h1>
                <a class="blog-title">PyTorch’s Tracing Based Selective Build</a>
            </h1>
        </div>
    </div>

    <div class="main-content-wrapper blog-detail-wrapper">
        <div class="main-content blog-detail-content">
            <div class="container">
                <img src="/assets/images/logo-icon.svg" class="img-fluid author-icon">
                <article class="pytorch-article">
                    <p class="author">
                      by
                      
                        Dhruv Matani, Suraj Subramanian
                      
                    </p>
                    <h2 id="introduction">Introduction</h2>

<p><strong>TL;DR</strong>: It can be challenging to run PyTorch on mobile devices, SBCs (Single Board Computers), and IOT devices. When compiled, the PyTorch library is huge and includes dependencies that might not be needed for the on-device use case.</p>

<p>To run a specific set of models on-device, we actually require only a small subset of the features in the PyTorch library. We found that using a PyTorch runtime generated using <strong>selective build</strong> can achieve up to 90% reduction in binary size (for the CPU and QuantizedCPU backends on an x86-64 build on Linux). In this blog, we share our experience of generating model-specific minimal runtimes using Selective Build and show you how to do the same.</p>

<h2 id="why-is-this-important-for-app-developers">Why is this important for app developers?</h2>

<p>Using a PyTorch runtime generated by <strong>selective build</strong> can reduce the size of AI-powered apps by 30+ MB - a significant reduction for a typical mobile app! Making mobile applications more lightweight has many benefits - they are runnable on a wider variety of devices, consume less cellular data, and can be downloaded and updated faster on user’s devices.</p>

<h2 id="what-does-the-developer-experience-look-like">What does the Developer Experience look like?</h2>

<p>This method can work seamlessly with any existing PyTorch Mobile deployment workflows. All you need to do is replace the general PyTorch runtime library with a runtime customized for the specific models you wish to use in your application. The general steps in this process are:</p>

<ol>
  <li>Build the PyTorch Runtime in <strong>instrumentation mode</strong> (this is called an <strong>instrumentation build</strong> of PyTorch). This will record the used operators, kernels and features.</li>
  <li>Run your models through this instrumentation build by using the provided <strong>model_tracer</strong> binary. This will generate a single YAML file that stores all the features used by your model. These features will be preserved in the minimal runtime.</li>
  <li>Build PyTorch using this YAML file as input. This is the <strong>selective build</strong> technique, and it greatly reduces the size of the final PyTorch binary.</li>
  <li>Use this selectively-built PyTorch library to reduce the size of your mobile application!</li>
</ol>

<p>Building the PyTorch Runtime in a special <strong>“instrumentation” mode</strong> ( by passing the <code class="language-plaintext highlighter-rouge">TRACING_BASED=1</code> build option) generates an <strong>instrumentation build</strong> runtime of PyTorch, along with a <strong>model_tracer</strong> binary. Running a model with this build allows us to trace the parts of PyTorch used by the model.</p>

<p align="center">
  <img src="/assets/images/pytorchs-tracing-based-selective-build_Figure1.png" width="100%" />
</p>

<p align="center">
  <i>Figure 1: Instrumentation build of PyTorch</i>
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Clone the PyTorch repo
</span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">pytorch</span><span class="o">/</span><span class="n">pytorch</span><span class="p">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">pytorch</span>

<span class="c1"># Build the model_tracer
</span><span class="n">USE_NUMPY</span><span class="o">=</span><span class="mi">0</span> <span class="n">USE_DISTRIBUTED</span><span class="o">=</span><span class="mi">0</span> <span class="n">USE_CUDA</span><span class="o">=</span><span class="mi">0</span> <span class="n">TRACING_BASED</span><span class="o">=</span><span class="mi">1</span> \
  <span class="n">python</span> <span class="n">setup</span><span class="p">.</span><span class="n">py</span> <span class="n">develop</span>
</code></pre></div></div>

<p>Now this instrumentation build is used to run a model inference with representative inputs. The <strong>model_tracer</strong> binary observes parts of the instrumentation build that were activated during the inference run, and dumps it to a YAML file.</p>

<p align="center">
  <img src="/assets/images/pytorchs-tracing-based-selective-build_Figure2.png" width="100%" />
</p>

<p align="center">
  <i>Figure 2: YAML file generated by running model(s) on an instrumentation build</i>
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Generate YAML file
</span><span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">model_tracer</span> \
  <span class="o">--</span><span class="n">model_input_path</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">path_to_model</span><span class="p">.</span><span class="n">ptl</span> \
  <span class="o">--</span><span class="n">build_yaml_path</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">selected_ops</span><span class="p">.</span><span class="n">yaml</span>
</code></pre></div></div>

<p>Now we build the PyTorch Runtime again, but this time using the YAML file generated by the tracer. The runtime now only includes those parts that are needed for this model. This is called <strong>“Selectively built PyTorch runtime”</strong> in the diagram below.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Clean out cached configuration
</span><span class="n">make</span> <span class="n">clean</span>

<span class="c1"># Build PyTorch using Selected Operators (from the YAML file)
# using the host toolchain, and use this generated library
</span><span class="n">BUILD_PYTORCH_MOBILE_WITH_HOST_TOOLCHAIN</span><span class="o">=</span><span class="mi">1</span> \
<span class="n">USE_LIGHTWEIGHT_DISPATCH</span><span class="o">=</span><span class="mi">0</span> \
<span class="n">BUILD_LITE_INTERPRETER</span><span class="o">=</span><span class="mi">1</span> \
<span class="n">SELECTED_OP_LIST</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">selected_ops</span><span class="p">.</span><span class="n">yaml</span> \
<span class="n">TRACING_BASED</span><span class="o">=</span><span class="mi">1</span> \
  <span class="p">.</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">build_mobile</span><span class="p">.</span><span class="n">sh</span>
</code></pre></div></div>

<p align="center">
  <img src="/assets/images/pytorchs-tracing-based-selective-build_Figure3.png" width="100%" />
</p>

<p align="center">
  <i>Figure 3: Selective Build of PyTorch and model execution on a selectively built PyTorch runtime</i>
</p>

<h3 id="show-me-the-code">Show me the code!</h3>

<p>We’ve put together a <a href="https://gist.github.com/dhruvbird/65fd800983f362a72d78afe68031568c">notebook</a> to illustrate what the process above looks like in code using a simple PyTorch model.</p>

<p>For a more hands-on tutorial to deploy this on Android/iOS <a href="https://pytorch.org/tutorials/prototype/tracing_based_selective_build.html">this tutorial</a> should be helpful.</p>

<h2 id="technical-faqs">Technical FAQs</h2>

<h3 id="why-is-tracing-needed-for-a-selective-build-of-pytorch">Why is Tracing needed for a Selective Build of PyTorch?</h3>

<p>In PyTorch, CPU kernels can call other operators via the <a href="http://blog.ezyang.com/2020/09/lets-talk-about-the-pytorch-dispatcher/">PyTorch Dispatcher</a>. Simply including the set of root operators called directly by the model is not sufficient as there might be many more being called under-the-hood transitively. Running the model on representative inputs and observing the actual list of operators called (aka “tracing”) is the most accurate way of determining what parts of PyTorch are used.</p>

<p>Additionally, factors such as which dtypes a kernel should handle are also runtime features that depend on actual input provided to the model. Hence, the tracing mechanism is extremely suitable for this purpose.</p>

<h3 id="which-features-can-be-selected-in-or-out-by-using-tracing-based-selective-build">Which features can be selected (in or out) by using Tracing Based Selective Build?</h3>

<p>The following features can be selected for the PyTorch runtime during the tracing based selective build process:</p>

<ol>
  <li><a href="https://codebrowser.bddppq.com/pytorch/pytorch/build/aten/src/ATen/">CPU/QuantizedCPU</a> kernels for <a href="https://pytorch.org/cppdocs/">PyTorch’s ATen Operators</a>: If a PyTorch Operator is not needed by a model targeted at a selectively built runtime, then the registration of that CPU kernel is omitted in the runtime. This is controlled via <a href="https://github.com/pytorch/pytorch/blob/master/torchgen/gen.py">Torchgen code-gen</a>.</li>
  <li><a href="https://github.com/pytorch/pytorch/blob/master/torch/csrc/jit/runtime/register_prim_ops.cpp">Primary Operators</a>: This is controlled by a macro named <a href="https://codebrowser.bddppq.com/pytorch/pytorch/torch/library.h.html">TORCH_SELECTIVE_SCHEMA</a> (via templated selective build) that either selects a primary operator or de-selects it based on information in a generated header file.</li>
  <li>Code that handles <a href="https://codebrowser.bddppq.com/pytorch/pytorch/aten/src/ATen/Dispatch.h.html">specific dtypes</a> in CPU kernels: This is performed by generating exception throws in specific case statements in the switch case generated by the macro <a href="https://codebrowser.bddppq.com/pytorch/pytorch/aten/src/ATen/Dispatch.h.html#_M/AT_PRIVATE_CHECK_SELECTIVE_BUILD">AT_PRIVATE_CHECK_SELECTIVE_BUILD</a>.</li>
  <li>Registration of <a href="https://pytorch.org/tutorials/advanced/torch_script_custom_classes.html">Custom C++ Classes</a> that extend PyTorch: This is controlled by the macro <a href="https://github.com/pytorch/pytorch/blob/master/aten/src/ATen/native/quantized/cpu/fbgemm_utils.cpp#L385-L386">TORCH_SELECTIVE_CLASS</a>, which can be used when registering Custom C++ Classes. The <a href="https://github.com/pytorch/pytorch/blob/master/torch/custom_class.h#L443-L460">torch::selective_class_&lt;&gt;</a> helper is to be used in conjunction with the macro <a href="https://codebrowser.bddppq.com/pytorch/pytorch/torch/library.h.html#_M/TORCH_SELECTIVE_CLASS">TORCH_SELECTIVE_CLASS</a>.</li>
</ol>

<h3 id="what-is-the-structure-of-the-yaml-file-used-during-the-build">What is the structure of the YAML file used during the build?</h3>

<p>The YAML file generated after tracing looks like the example below. It encodes all the elements of the “selectable” build feature as specified above.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">include_all_non_op_selectives</span><span class="p">:</span> <span class="n">false</span>
<span class="n">build_features</span><span class="p">:</span> <span class="p">[]</span>
<span class="n">operators</span><span class="p">:</span>
    <span class="n">aten</span><span class="p">::</span><span class="n">add</span><span class="p">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="n">is_used_for_training</span><span class="p">:</span> <span class="n">false</span>
        <span class="n">is_root_operator</span><span class="p">:</span> <span class="n">true</span>
        <span class="n">include_all_overloads</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">aten</span><span class="p">::</span><span class="nb">len</span><span class="p">.</span><span class="n">t</span><span class="p">:</span>
        <span class="n">is_used_for_training</span><span class="p">:</span> <span class="n">false</span>
        <span class="n">is_root_operator</span><span class="p">:</span> <span class="n">true</span>
        <span class="n">include_all_overloads</span><span class="p">:</span> <span class="n">false</span>
<span class="n">kernel_metadata</span><span class="p">:</span>
    <span class="n">_local_scalar_dense_cpu</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Float</span>
    <span class="n">add_stub</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Float</span>
    <span class="n">copy_</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Bool</span>
    <span class="o">-</span> <span class="n">Byte</span>
    <span class="n">mul_cpu</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Float</span>
<span class="n">custom_classes</span><span class="p">:</span> <span class="p">[]</span>
</code></pre></div></div>

<h3 id="how-exactly-is-code-eliminated-from-the-generated-binary">How exactly is code eliminated from the generated binary?</h3>

<p>Depending on the specific scenario, there are 2 main techniques that are used to hint the compiler and linker about unused and unreachable code. This code is then cleaned up by the compiler or linker as unreachable code.</p>

<h4 id="1-unreferenced-functions-removed-by-the-linker">[1] Unreferenced functions removed by the Linker</h4>

<p>When a function that isn’t transitively referenced from any visible function is present in the compiled object files that are being linked together, the linker will remove it (if the right build flags are provided). This is leveraged in 2 scenarios by the selective build system.</p>

<h5 id="kernel-registration-in-the-dispatcher">Kernel Registration in the Dispatcher</h5>

<p>If an operator’s kernel isn’t needed, then it isn’t registered with the dispatcher. An unregistered kernel means that the function is unreachable, and it will be removed by the linker.</p>

<h5 id="templated-selective-build">Templated Selective Build</h5>

<p>The general idea here is that a class template specialization is used to select a class that either captures a reference to a function or not (depending on whether it’s used) and the linker can come along and clean out the unreferenced function.</p>

<p>For example, in the code below, there’s no reference to the function “<code class="language-plaintext highlighter-rouge">fn2</code>”, so it will be cleaned up by the linker since it’s not referenced anywhere.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#include &lt;vector&gt;
#include &lt;cstdio&gt;
</span>
<span class="n">template</span> <span class="o">&lt;</span><span class="n">typename</span> <span class="n">T</span><span class="p">,</span> <span class="nb">bool</span><span class="o">&gt;</span>
<span class="n">struct</span> <span class="n">FunctionSelector</span> <span class="p">{</span>
    <span class="n">T</span> <span class="n">fn_</span><span class="p">;</span>
    <span class="n">FunctionSelector</span><span class="p">(</span><span class="n">T</span> <span class="n">fn</span><span class="p">):</span> <span class="n">fn_</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">T</span> <span class="n">get</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">fn_</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="o">//</span> <span class="n">The</span> <span class="s">"false"</span> <span class="n">specialization</span> <span class="n">of</span> <span class="n">this</span> <span class="k">class</span> <span class="nc">does</span> <span class="n">NOT</span> <span class="n">retain</span> <span class="n">the</span> <span class="n">argument</span> <span class="n">passed</span>
<span class="o">//</span> <span class="n">to</span> <span class="n">the</span> <span class="k">class</span> <span class="nc">constructor</span><span class="p">,</span> <span class="n">which</span> <span class="n">means</span> <span class="n">that</span> <span class="n">the</span> <span class="n">function</span> <span class="n">pointer</span> <span class="n">passed</span> <span class="ow">in</span>
<span class="o">//</span> <span class="ow">is</span> <span class="n">considered</span> <span class="n">to</span> <span class="n">be</span> <span class="n">unreferenced</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">program</span> <span class="p">(</span><span class="n">unless</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">referenced</span>
<span class="o">//</span> <span class="n">elsewhere</span><span class="p">).</span>
<span class="n">template</span> <span class="o">&lt;</span><span class="n">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">struct</span> <span class="n">FunctionSelector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">false</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">FunctionSelector</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="n">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">FunctionSelector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">true</span><span class="o">&gt;</span> <span class="n">make_function_selector_true</span><span class="p">(</span><span class="n">T</span> <span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">FunctionSelector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">true</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="n">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">FunctionSelector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">false</span><span class="o">&gt;</span> <span class="n">make_function_selector_false</span><span class="p">(</span><span class="n">T</span> <span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">FunctionSelector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">typedef</span> <span class="n">void</span><span class="p">(</span><span class="o">*</span><span class="n">fn_ptr_type</span><span class="p">)();</span>

<span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">fn_ptr_type</span><span class="o">&gt;</span> <span class="n">fns</span><span class="p">;</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="n">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">void</span> <span class="n">add_fn</span><span class="p">(</span><span class="n">FunctionSelector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">true</span><span class="o">&gt;</span> <span class="n">fs</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fns</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="p">}</span>

<span class="n">template</span> <span class="o">&lt;</span><span class="n">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">void</span> <span class="n">add_fn</span><span class="p">(</span><span class="n">FunctionSelector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">false</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Do</span> <span class="n">nothing</span><span class="p">.</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">fn1</span> <span class="n">will</span> <span class="n">be</span> <span class="n">kept</span> <span class="n">by</span> <span class="n">the</span> <span class="n">linker</span> <span class="n">since</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">added</span> <span class="n">to</span> <span class="n">the</span> <span class="n">vector</span> <span class="s">"fns"</span> <span class="n">at</span>
<span class="o">//</span> <span class="n">runtime</span><span class="p">.</span>
<span class="n">void</span> <span class="n">fn1</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"fn1</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">fn2</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="n">by</span> <span class="n">the</span> <span class="n">linker</span> <span class="n">since</span> <span class="n">it</span> <span class="n">isn</span><span class="s">'t referenced at all.
void fn2() {
    printf("fn2</span><span class="se">\n</span><span class="s">");
}

int main() {
    add_fn(make_function_selector_true(fn1));
    add_fn(make_function_selector_false(fn2));
}
</span></code></pre></div></div>

<h4 id="2-dead-code-eliminated-by-the-compiler">[2] Dead Code Eliminated by the Compiler</h4>

<p>C++ Compilers can detect dead (<a href="https://en.wikipedia.org/wiki/Unreachable_code">unreachable</a>) code by analyzing the code’s control flow statically. For example, if there’s a code-path that comes after an <strong>unconditional exception throw</strong>, then all the code after it will be marked as dead code and not converted to object code by the compiler. Typically, compilers require the use of the <code class="language-plaintext highlighter-rouge">-fdce</code> flag to eliminate dead code.</p>

<p>In the example below, you can see that the C++ code on the left (in the red boxes) doesn’t have any corresponding generated object code on the right.</p>

<p align="center">
  <img src="/assets/images/pytorchs-tracing-based-selective-build_Figure_4.png" width="100%" />
</p>

<p align="center">
  <i>Figure 4: Dead Code Elimination by C++ Compilers</i>
</p>

<p>This property is leveraged in the bodies of PyTorch kernel implementations that have a lot of repeated code to handle multiple dtypes of a Tensor. A <a href="https://pytorch.org/docs/stable/tensor_attributes.html">dtype</a> is the underlying data-type that the Tensor stores elements of. This can be one of float, double, int64, bool, int8, etc…</p>

<p>Almost every PyTorch CPU kernel uses a macro of the form AT_DISPATCH_ALL_TYPES* that is used to substitute some code specialized for every dtype that the kernel needs to handle. For example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AT_DISPATCH_ALL_TYPES_AND_COMPLEX_AND3</span><span class="p">(</span>
    <span class="n">kBool</span><span class="p">,</span> <span class="n">kHalf</span><span class="p">,</span> <span class="n">kBFloat16</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="s">"copy_kernel"</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">{</span>
  <span class="n">cpu_kernel_vec</span><span class="p">(</span>
      <span class="nb">iter</span><span class="p">,</span>
      <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="n">scalar_t</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">scalar_t</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="p">;</span> <span class="p">},</span>
      <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="n">Vectorized</span><span class="o">&lt;</span><span class="n">scalar_t</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Vectorized</span><span class="o">&lt;</span><span class="n">scalar_t</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span><span class="p">;</span> <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>The macro <code class="language-plaintext highlighter-rouge">AT_DISPATCH_ALL_TYPES_AND_COMPLEX_AND3</code> internally has a switch-case statement that looks like the code in Figure-4 above. The tracing process records the dtypes triggered for the kernel tag “<code class="language-plaintext highlighter-rouge">copy_kernel</code>” and the build process processes these tags and inserts <code class="language-plaintext highlighter-rouge">throw</code> statements in every <code class="language-plaintext highlighter-rouge">case</code> statement that is handling the dtype that isn’t required for this kernel tag.</p>

<p>This is how dtype selectivity is implemented in PyTorch’s Tracing Based Selective Build.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Tracing Based Selective Build is a practical and scalable approach to selecting only the used parts of an application to retain code that static analysis can not detect. This code is usually extremely data/input dependent in nature.</p>

<p>This article provides detailed insights into how Tracing Based Selective Build works under the hood, and the technical details related to its implementation. These techniques can also be applied to other applications and situations that can benefit from reduced binary size.</p>

                </article>
            </div>
        </div>
    </div>

<!--    


 -->
    <div class="container-fluid docs-tutorials-resources">
  <div class="container">
    <div class="row">
      <div class="col-md-4 text-center">
        <h2>Docs</h2>
        <p>Access comprehensive developer documentation for PyTorch</p>
        <a class="with-right-arrow" href="/docs">View Docs</a>
      </div>

      <div class="col-md-4 text-center">
        <h2>Tutorials</h2>
        <p>Get in-depth tutorials for beginners and advanced developers</p>
        <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
      </div>

      <div class="col-md-4 text-center">
        <h2>Resources</h2>
        <p>Find development resources and get your questions answered</p>
        <a class="with-right-arrow" href="/resources">View Resources</a>
      </div>
    </div>
  </div>
</div>

<footer class="site-footer">
  <div class="container footer-container">
    <div class="footer-logo-wrapper">
      <a href="https://pytorch.org" class="footer-logo"></a>
    </div>

    <div class="footer-links-wrapper">
      <div class="footer-links-col">
        <ul>
          <li class="list-title"><a href="https://pytorch.org">PyTorch</a></li>
          <li><a href="/get-started">Get Started</a></li>
          <li><a href="/features">Features</a></li>
          <li><a href="/ecosystem">Ecosystem</a></li>
          <li><a href="/blog">Blog</a></li>
          <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md" target="_blank">Contributing</a></li>
          <li><a href="https://github.com/pytorch/pytorch/security/policy" target="_blank">Security</a></li>
        </ul>
      </div>

      <div class="footer-links-col">
        <ul>
          <li class="list-title"><a href="/resources">Resources</a></li>
          <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
          <li><a href="/docs">Docs</a></li>
          <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
          <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">GitHub Issues</a></li>
          <li><a href="/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
        </ul>
      </div>

      <div class="footer-links-col">
        <ul>
          <li class="list-title"><p>Stay up to date</p></li>
          <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
          <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
          <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
          <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          <li><a href="https://social.lfx.dev/@pytorch" rel="me" target="_blank">Mastodon</a></li>
        </ul>
      </div>

      <div class="footer-links-col">
        <ul>
          <li class="list-title"><p>PyTorch Podcasts</p></li>
          <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
          <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
          <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
          <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
        </ul>
      </div>
    </div>

    <div class="privacy-policy">
      <ul>
        <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
        <li class="privacy-policy-links">|</li>
        <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
      </ul>
      <div class="copyright">
        <p>© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation. 
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see 
          <a href="https://www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source 
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC, 
          please see <a href="https://www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
    </div>
  </div>
  <img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0"/>

</footer>

<div class="mobile-main-menu">
  <div class="container-fluid">
    <div class="container">
      <div class="mobile-main-menu-header-container">
        <a class="header-logo" href="https://pytorch.org" aria-label="PyTorch"></a>
        <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
      </div>
    </div>
  </div>

  <div class="mobile-main-menu-links-container">

    <div class="main-menu">
      <ul>
        <li class="navSearchWrapper reactNavSearchWrapper tabletSearchWrapper" key="search">
          <div class="mobile-search-border">
            <input
              id="mobile-search-input"
              type="text"
              title="Search"
            />
            <div id="mobile-search-icon"></div>
          </div>
        </li>

        <li class="">
          <a href="/get-started">Get Started</a>
        </li>

        <li class="resources-mobile-menu-title">
          <a>Ecosystem</a>
        </li>
        <ul class="resources-mobile-menu-items">
          <li>
            <a href="https://events.linuxfoundation.org/pytorch-conference/">PyTorch Conference - 2024</a>
          </li>
          <li>
            <a href="/ecosystem">Tools</a>
          </li>
        </ul>

        <li class="resources-mobile-menu-title">
          <a>Edge</a>
        </li>
        <ul class="resources-mobile-menu-items">
          <li>
            <a href="/edge">About PyTorch Edge</a>
          </li>
          <li>
            <a href="/executorch-overview">ExecuTorch</a>
          </li>
        </ul>

        <li class="active">
          <a href="/blog">Blog</a>
        </li>

        <li>
          <a href="https://pytorch.org/tutorials">Tutorials</a>
        </li>

        <li class="resources-mobile-menu-title">
          <a href="/docs">Docs</a>
        </li>

        <ul class="resources-mobile-menu-items">
          <li class="">
            <a href="/docs">PyTorch</a>
          </li>

          <li class="">
            <a href="/audio">torchaudio</a>
          </li>

          <li class="">
            <a href="/text">torchtext</a>
          </li>

          <li class="">
            <a href="/vision">torchvision</a>
          </li>

          <li class="">
            <a href="/torcharrow">torcharrow</a>
          </li>

          <li class="">
            <a href="/data">TorchData</a>
          </li> 

          <li class="">
            <a href="/torchrec">TorchRec</a>
          </li>

          <li class="">
            <a href="/serve">TorchServe</a>
          </li>

          <li class="">
            <a href="/xla/release/1.6/index.html">PyTorch on XLA Devices</a>
          </li>
        </ul>

        <li class="resources-mobile-menu-title">
          Resources
        </li>

        <ul class="resources-mobile-menu-items">
          <li class="">
            <a href="/features">About</a>
          </li>

          <li>
            <a href="/foundation">PyTorch Foundation</a>
          </li>
          
          <li>
            <a href="/#community-module">Community</a>
          </li>
          
          <li class="">
            <a href="/community-stories">Community stories</a>
          </li>

          <li class="">
            <a href="/resources">Developer Resources</a>
          </li>

          <li>
            <a href="/events">Events</a>
          </li>

          <li>
            <a href="https://discuss.pytorch.org">Forum</a>
          </li>

          <li class="">
            <a href="/hub">Models (Beta)</a>
          </li>

        </ul>

        <li id="github-mobile-menu-link">
          <a href="https://github.com/pytorch/pytorch">GitHub</a>
        </li>
      </ul>
    </div>

  </div>
</div>


<script src="/assets/mobile-menu.js"></script>
<script src="/assets/scroll-to-anchor.js"></script>
<script src="/assets/external-links-new-tab.js"></script>

  <script src="/assets/search-bar.js"></script>

<script src="/assets/cookie-banner.js"></script>

<script type="text/javascript">
  mobileMenu.bind();
  anchors.add('.pytorch-article h2, .pytorch-article h3, .pytorch-article h4, .pytorch-article h5');

  // Add class to links that have code blocks, since we cannot create links in code blocks
  $("a code.highlighter-rouge").each(function(e) {
    $(this).closest("a").addClass("has-code");
  });

  scrollToAnchor.bind();

  var hasStaticHeader = $(".blog-header, .blog-detail-header, .resources-header, .get-started-header, .features-header, .ecosystem-header, .hub-header, .mobile-header").length > 0;

  if (!hasStaticHeader) {
    $(window).on("scroll", function() {
      var top = $(this).scrollTop();
      var fullPosition = $(".main-background").height() - $(".header-holder").height();

      if (top <= 40) {
        $(".header-holder").css({"backgroundColor": "rgba(0, 0, 0, 0.165)"});
      } else if (top >= fullPosition) {
        $(".header-holder").css({"backgroundColor": "#000000"});
      } else {
        var bgColor = "rgba(0, 0, 0, " + top / fullPosition + ")";
        $(".header-holder").css({"backgroundColor": bgColor});
      }
    });
  }
</script>


  <script src="/assets/track-events.js"></script>
  <script>trackEvents.bind();</script>



<div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="/assets/images/pytorch-x.svg">
  </div>
</div>


</body>

</html>
